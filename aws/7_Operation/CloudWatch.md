# CloudWatch

- [AWSブログリレー：Amazon CloudWatchとは？無料枠で始めるAWSシステム監視のメリットと使い方](https://iret.media/172240)

## Functions
- `Metrics`:                        数値データの時系列データ（CPU使用率等）
  - 種類:
    - `標準メトリクス`:             AWSが自動収集
    - `カスタムメトリクス`:         ==メトリクス数に応じた課金== / 独自に送信
  - 解像度:
    - `Standard`:                   ==無料== / 5分間隔 / デフォルト
    - `Detailed`:                   ==有料== / 1 分間隔
    - `High Resolution`:            ==有料== / 1秒間隔 / カスタムメトリクスのみ
- `Alarms`:                         メトリクスの閾値監視・通知
  - 状態:                         `OK` / `ALARM` / `INSUFFICIENT_DATA`
  - アクション:                   SNS通知, Auto Scaling, EC2アクション（停止/終了/再起動）
  - 設定例:
    - 対象:                       Composite Alarms（複合アラーム）もいける
      - メトリクス:               CPU使用率
      - 閾値:                     80%以上
    - `Period`:                     5分 (最小10秒)
    - `Evaluation Periods`:         3回
- `Logs`:                           ログデータの収集・保存・分析
  - 構成要素:
    - `Log Groups`:                 アプリや環境単位
      - `Log Streams`:              インスタンスやコンテナ単位
        - `Log Events`:             個々のログ行
  - ソース:
    - EC2                         CloudWatch Agent / 手動設定
    - Lambda                      自動 / IAM 権限のみ
    - VPC                         フローログ設定 / S3 も選択可
    - ECS/Fargate                 awslogs ドライバー / タスク定義で指定
    - API Gateway                 ステージ設定 / IAM ロール必要
    - RDS                         エクスポート設定 / エンジンにより異なる
  - 料金:
    - データ取り込み:
      - `Standard`:                 $0.76/GB / 全機能利用可
      - `Infrequent Access`:        $0.38/GB / 取り込み50%オフ / Metric Filter, Subscription Filter 使用不可
    - 保存 (アーカイブ)           S3 ではない
      - 標準                      $0.033 / GB / 月
      - 低頻度アクセス            $0.0165 / GB / 月
    - Logs Insights クエリ        $0.0076 / GB スキャン
  - 保持期間:
    - `ロググループ単位で設定`
    - `デフォルトで無期限`          1日、3日、5日、1週間、2週間、1ヶ月...10年、無期限
  - `Metric Filters`:               ログからメトリクスを生成（リアルタイムのみ、過去ログ不可）
  - `Subscription Filters`:         ログをリアルタイム転送（1ロググループあたり最大2つ）
    - 転送先:                     Lambda / Kinesis Data Stream / Kinesis Data Firehose
  - `Log Insights`:                 ログのクエリ・分析（過去ログも可）
  - `CloudWatch Agent`:             メモリ使用率, ディスク使用率, カスタムログ
- `EventBridge`:                    ※現在は CloudWatch とは別サービス
  - イベント駆動:                 状態変化やアクションがトリガー, 数値ではなく「何が起きたか」
  - スケジュール:                 cron(0 12 * * ? *) → 毎日12時(UTC)に実行 / rate(5 minutes) → 5分ごとに実行
- `Dashboards`:                     可視化ダッシュボード / $3/月/ダッシュボード（最初の3つは無料）
  - クロスリージョン:             追加設定不要
  - クロスアカウント:             設定が必要
