# Amazon API Gateway

```
+-------------+       +------------------+       +-------------------+
|   Client    | ----> |   API Gateway    | ----> |   Backend         |
| - Browser   |       |   - REST API     |       |   - Lambda        |
| - Mobile    |       |   - HTTP API     |       |   - EC2/ECS       |
| - IoT       |       |   - WebSocket    |       |   - Any HTTP      |
+-------------+       +------------------+       +-------------------+
                              |
                              v
                      +----------------+
                      | - 認証/認可    |
                      | - スロットリング|
                      | - キャッシュ   |
                      | - 変換        |
                      +----------------+
```

## Functions
- API type:
  - `REST API`:             ==$3.50/100万リクエスト== (最初の3.33億) / 機能豊富 (API キー,使用量プラン,リクエスト検証,WAF統合)
  - `HTTP API`:             ==$1.00/100万リクエスト== (最初の3億) / 低レイテンシー / シンプルなプロキシ向け
  - `WebSocket API`:        ==$1.00/100万メッセージ== / ==$0.25/100万接続分== / 双方向リアルタイム通信 / チャット,ゲーム,,,
- `Endpoint type`:
  - `Regional`:             同 Region → API Gateway (Region) / ==追加コストなし==
  - `Edge-Optimized`:       ==default== / 世界中 → CloudFront → API Gateway (Region) / ==CloudFrontのデータ転送料金==
  - `Private`:              VPC内のリソース → VPCエンドポイント → API Gateway / ==VPCエンドポイント料金==
- 統合タイプ:
  - Lambda:               Lambda関数を直接呼び出し
  - HTTP:                 任意のHTTPエンドポイント
  - AWS Service:          AWSサービスを直接呼び出し (S3, DynamoDB, Step Functions等)
  - Mock:                 バックエンドなしでレスポンス返却 (テスト用)
  - VPC Link:             VPC内のリソース (ALB, NLB, EC2) に接続
- `Stage`:                  dev, staging, prod などの環境分離 / ステージ変数でパラメータ化
- `Cache`:                  ==$0.02〜3.80/h== / 0.5GB〜237GB / TTL 0〜3600秒 / レスポンス一時保存、BE へのリクエストを減らす
- 認証・認可:
  - `IAM 認証`:             AWS署名v4 / Client (AWS SDK/CLI)
  - `Cognito User Pools`:   JWTトークン / モバイル/Webアプリユーザー認証
  - `Lambda Authorizer`:    カスタム認証ロジック / 独自トークン、サードパーティ認証
  - `API Key`:              シンプルなキー認証 / 使用量制限・課金用 (認証には不十分)
- `スロットリング`:         APIへのリクエスト数を制限し、バックエンドを過負荷から保護する仕組み
  - 制限値:
    - `レート`:             1秒あたりの定常リクエスト数 (default: 10,000 req/sec)
    - `バースト`:           瞬間的に許容する最大数 (default: 5,000 req)
  - 制限の階層:
    - ```txt
      +----------------------------------+
      |  アカウント上限 (リージョン全体)   |  10,000 req/sec
      +----------------------------------+
                    |
      +----------------------------------+
      |  ステージ上限                     |  例: 5,000 req/sec
      +----------------------------------+
                    |
      +----------------------------------+
      |  メソッド上限                     |  例: GET /users → 1,000 req/sec
      +----------------------------------+
                    |
      +----------------------------------+
      |  使用量プラン (APIキー単位)        |  例: 顧客Aは 100 req/sec
      +----------------------------------+
      ```
- `CORS`:                    Cross-Origin Resource Sharing / ブラウザが異なるオリジンへのリクエストを許可する仕組み
  - ```txt
    [オリジン]

    https://example.com:443/path/page.html
      |         |        |
    スキーム  ホスト   ポート

    → この3つの組み合わせ
    ```
