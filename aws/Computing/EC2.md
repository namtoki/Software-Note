# Amazon EC2 (Elastic Compute Cloud)

```
+----------------------------------------------------------+
|                        Amazon EC2                        |
|  +----------------------------------------------------+  |
|  |                      EC2 Instance                  |  |
|  |  +------------------+  +------------------+        |  |
|  |  |     vCPU         |  |     Memory       |        |  |
|  |  +------------------+  +------------------+        |  |
|  |  +------------------+  +------------------+        |  |
|  |  | Instance Store   |  |    EBS Volume    |        |  |
|  |  | (ephemeral)      |  |   (persistent)   |        |  |
|  |  +------------------+  +------------------+        |  |
|  |  +----------------------------------------------+  |  |
|  |  |              Network Interface (ENI)         |  |  |
|  |  +----------------------------------------------+  |  |
|  +----------------------------------------------------+  |
+----------------------------------------------------------+
```

## Overview
- Instance:
  - Instance type:
    - ```txt
      m   5   d   .   xlarge
      |   |   |       |
      |   |   |       +------ サイズ (nano, micro, small, medium, large, xlarge, 2xlarge...)
      |   |   +-------------- 追加機能 (d=NVMe SSD, n=ネットワーク強化, a=AMD, g=Graviton...)
      |   +------------------ 世代番号
      +---------------------- ファミリー (汎用, コンピューティング最適化, メモリ最適化...)
      ```
      | ファミリー | 用途 | ユースケース |
      |-----------|------|-------------|
      | T (T3, T3a, T4g) | バースト可能汎用 | 開発環境、小規模Web、マイクロサービス |
      | M (M5, M6i, M7g) | 汎用 | Webサーバー、アプリサーバー、エンタープライズアプリ |
      | `C (C5, C6i, C7g)` | `コンピューティング最適化` | バッチ処理、ゲームサーバー、科学計算 |
      | `R (R5, R6i, R7g)` | `メモリ最適化` | インメモリDB、リアルタイム分析、SAP HANA |
      | X (X1, X2idn) | 大容量メモリ | SAP HANA、大規模インメモリDB |
      | I (I3, I4i) | ストレージ最適化 | NoSQL DB、データウェアハウス |
      | D (D2, D3) | 高密度ストレージ | 分散ファイルシステム、Hadoop |
      | P (P3, P4, P5) | GPU (汎用) | 機械学習、ディープラーニング |
      | G (G4, G5) | GPU (グラフィックス) | ゲームストリーミング、3Dレンダリング |
      | Inf (Inf1, Inf2) | 推論最適化 | 機械学習推論 (AWS Inferentia) |
      | Trn (Trn1) | 学習最適化 | 機械学習トレーニング (AWS Trainium) |
      | HPC (Hpc6a, Hpc7g) | HPC最適化 | 高性能コンピューティング |
  - Plans:
    - `On-Demand Instance`:                 ==!$0.0136~0.248/h 秒単位 (最低60秒)== / 前払い・長期契約なし / いつでも起動・停止可能
    - `Reserved Instance (RI)`:             ==インスタンス属性のコミット== / 1 or 3 年 / 全額前払い, 一部前払い, 前払いなし / 停止中も課金
      - `Standard RI`:                      ==!最大72%割引== / インスタンスタイプ固定 / Marketplace リセール可能
      - `Convertible RI`:                   ==!最大66%割引== / インスタンスタイプ変更可能 / Marketplace リセール不可
    - `Saving Plans`:                       ==使用量のコミット==
      - `Compute Savings Plans`:            ==!最大66%割引== / ファミリー自由 / リージョン自由 / Fargate/Lambda にも適用
      - `EC2 Instance Savings`:             ==!最大72%割引== / ファミリー固定 / リージョン固定 / EC2 のみ
    - `Spot Instance`:                      ==!最大90%割引== / AWS が回収可能 (2分前通知) / 余剰キャパシティを大幅な割引で使用
      - lowestPrice:                      最安のプールから起動 (デフォルト)
      - diversified:                      複数プールに分散 (可用性向上)
      - capacityOptimized:                容量が最も確保しやすいプールから起動
      - priceCapacityOptimized:           価格と容量のバランス (推奨)
    - `Dedicated Instance`:                 ==!$2/時間 + インスタンス料金== / ==任意の==物理サーバ専有
    - `Dedicated Host`:                     ==!ホスト料金== / ==指定の==物理サーバ専有 / ==BYOL対応== / ライセンス要件向け
    - `EC2 Fleet`:                          複数の購入オプションとインスタンスタイプを組み合わせ
  - `AMI`:                                  リージョン固有 / 他リージョンにコピー可 / 他アカウントに共有可
    - EBS-backed:                         停止/起動可能 (一般的)
    - Instance Store-backed:              停止不可 (terminate のみ)
  - `EC2 Image Builder`:                    AMI自動作成・テスト・配布 / パイプラインベース / セキュリティパッチ自動化
  - Volume:
    - `EBS`:                                ==!課金== / 永続的 / ネットワーク接続 / スナップショット可 / AZ固有
      - gp3:                              汎用SSD (デフォルト推奨)
      - io2:                              高IOPS (DB向け)
      - st1:                              スループット最適化HDD (ビッグデータ)
      - sc1:                              コールドHDD (アーカイブ)
      - Multi-Attach:                     io1/io2のみ / 同一AZ内で複数インスタンスにアタッチ
      - Snapshot:                         ==!$0.05/GB/月== / S3保存 / 増分バックアップ / リージョン間コピー可 / AMI作成可
      - 暗号化:                           KMS連携 / デフォルト暗号化設定可 / 暗号化⇔非暗号化はコピー時のみ
    - `Instance Store`:                     一時的 (停止/終了で消失) / 物理接続で高速 / バッファ,キャッシュ向け
  - Network:
    - `ENI (Elastic Network Interface)`:    複数アタッチ可 / フェイルオーバー用
      - Primary ENI (eth0):               インスタンス作成時に自動作成 / ==デタッチ不可==
      - Secondary ENI:                    追加でアタッチ可能 / ==デタッチ・再アタッチ可能==
        - 特徴:
          - 異なるサブネット:             ==同一AZ内==の別サブネットに接続可
          - 独立したSG:                   ENIごとに異なるセキュリティグループ設定可
          - 独立したIP:                   ENIごとにPrivate IP / Elastic IP を割り当て可
          - MAC アドレス:                 ENIごとに固有 / ライセンス管理に利用可
        - ユースケース:
          - Management Network:           管理用とデータ用のネットワーク分離
          - HA/Failover:                  障害時にENIを別インスタンスに移動
          - Dual-homed:                   複数サブネットへの同時接続
          - ライセンス管理:               MACアドレスベースのソフトウェアライセンス
        - 制限:
          - アタッチ数:                   インスタンスタイプにより異なる (2〜15)
          - AZ:                           ==同一AZ内のみ==移動可能
          - 実行中アタッチ:               一部インスタンスタイプのみホットアタッチ対応
    - `ENA (Elastic Network Adapter)`:      拡張ネットワーキング (最大100Gbps)
    - `EFA (Elastic Fabric Adapter)`:       HPC向け低レイテンシー
    - IP:
      - Private IP:                       VPC内通信
      - Public IP:                        ==動的== / インスタンス停止で変わる
      - Elastic IP:                       静的 / ==!$0.005/時間 (約 $3.6/月)== / リージョンあたり5つまで
  - Where:
    - `Placement Group`:
      - `Cluster`:                          同一AZ・近接配置 / 低レイテンシー / HPC向け
      - `Spread`:                           ==1ラックあたり1インスタンスのみ== / AZあたり7台まで / 高可用性向け
      - `Partition`:                        ==1ラックあたり複数インスタンス可== / Hadoop,Cassandra,Kafka向け
  - Security:
    - `Security Group`:                     ステートフル / 許可ルールのみ / イン (def=全拒否), アウト (def=全許可)
    - `Key Pair`:                           SSH接続用 (Linux) / パスワード復号用 (Windows)
    - `IAM Role`:                           AWSサービスへのアクセス / アクセスキーをインスタンスに保存しない
    - `IMDSv2`:                             メタデータ保護 / トークンベース (推奨)
  - Data:
    - `User Data`:                          起動時スクリプト / 初回起動時のみ / 16KB制限 / root実行
    - `Metadata (IMDS)`:                    インスタンス情報取得 / 169.254.169.254 / IMDSv2推奨
  - `Hibernation`:                          ==メモリ内容をEBSルートボリュームに保存==して休止 / 再開時にメモリ状態を復元
    - 条件:
      - ルートEBSボリューム:              ==暗号化必須== / メモリより大きいサイズが必要
      - RAM:                              最大150GB
      - インスタンスタイプ:               C, I, M, R, T ファミリーの一部
      - AMI:                              Amazon Linux 2, Ubuntu, Windows等の対応AMI
      - 購入オプション:                   オンデマンド, リザーブド, スポット
    - 制限:
      - 最大休止期間:                     ==60日間==
      - 起動時に有効化必須:               後から有効化不可
      - Instance Store 非対応:            EBS-backed インスタンスのみ
    - ユースケース:
      - 長時間実行プロセスの一時停止
      - 起動時間の短縮 (ブートシーケンスをスキップ)
      - 状態保持が必要なワークロード
    - Stop vs Hibernate:
      - Stop:                             メモリ消失 / EBSデータ保持 / 再起動が必要
      - Hibernate:                        ==メモリ保持== / EBSデータ保持 / 即座に再開可能
  - `Auto Scaling`:
    - ```txt
      +------------------------------------------------------------------+
      |                     Auto Scaling                                 |
      |  +------------------------------------------------------------+  |
      |  |               Launch Template / Launch Configuration       |  |
      |  |  (AMI, インスタンスタイプ, セキュリティグループ, etc.)     |  |
      |  +------------------------------------------------------------+  |
      |                              |                                   |
      |                              v                                   |
      |  +------------------------------------------------------------+  |
      |  |                  Auto Scaling Group (ASG)                  |  |
      |  |  +------------------+  +------------------+                |  |
      |  |  | 最小サイズ: 2    |  | 希望サイズ: 4    |                |  |
      |  |  +------------------+  +------------------+                |  |
      |  |  +------------------+                                      |  |
      |  |  | 最大サイズ: 10   |                                      |  |
      |  |  +------------------+                                      |  |
      |  +------------------------------------------------------------+  |
      |                              |                                   |
      |                              v                                   |
      |  +------------------------------------------------------------+  |
      |  |                   Scaling Policies                         |  |
      |  |  Target Tracking / Step / Simple / Scheduled / Predictive  |  |
      |  +------------------------------------------------------------+  |
      +------------------------------------------------------------------+
      ```
    - `Launch Template`:                    設定テンプレート (AMI, タイプ, SG等) / バージョニング可 / 推奨
    - `ASG`:                                最小/希望/最大サイズ / 複数AZに分散
    - Scaling Policy:
      - Target Tracking:                  メトリクスを目標値に維持 (CPU 50%等)
      - Step:                             閾値に応じて段階的スケール
      - Scheduled:                        時間ベース (毎朝9時等)
      - Predictive:                       ML予測
    - `Lifecycle Hook`:                     起動/終了時にカスタム処理
    - `Warm Pool`:                          事前ウォームアップ済みインスタンスをプール / 起動時間短縮
    - Cooldown:                           連続スケーリング防止 / デフォルト300秒
    - Termination Policy:                 スケールイン時の削除優先順位
      - デフォルト:                       ==古い起動テンプレート/バージョンのインスタンスを優先削除== → 最新構成に統一
