# Amazon ECS (Elastic Container Service)

AWSが提供するフルマネージド型コンテナオーケストレーションサービス。

## 基本概念

### コンポーネント構成

```
+----------------------------------------------------------+
|                      ECS Cluster                         |
|  +----------------------------------------------------+  |
|  |                     Service                        |  |
|  |  +--------------+  +--------------+                |  |
|  |  |    Task      |  |    Task      | <- 同一定義    |  |
|  |  | +----------+ |  | +----------+ |                |  |
|  |  | |Container | |  | |Container | |                |  |
|  |  | +----------+ |  | +----------+ |                |  |
|  |  +--------------+  +--------------+                |  |
|  +----------------------------------------------------+  |
+----------------------------------------------------------+
```

| コンポーネント | 説明 |
|---------------|------|
| **Cluster** | タスクやサービスの論理グループ |
| **Task Definition** | コンテナの設定を定義するJSON (イメージ, CPU, メモリ, ポート等) |
| **Task** | Task Definitionから起動されるコンテナの実行単位 |
| **Service** | 指定数のタスクを維持・管理する仕組み |
| **Container** | Docker コンテナそのもの |

---

## 起動タイプ

### 1. Fargate (サーバーレス)

```
+----------------------------------+
|         ECS on Fargate           |
|  +----------+  +----------+      |
|  |   Task   |  |   Task   |      |
|  +----------+  +----------+      |
|      インフラ管理不要             |
+----------------------------------+
```

- **インフラ管理不要** - EC2インスタンスのプロビジョニング・管理が不要
- **タスク単位での課金** - vCPUとメモリの使用量に基づく
- **自動スケーリング** - インフラを意識せずスケール可能
- **セキュリティ** - タスクごとに分離された環境

**ユースケース**: 運用負荷を減らしたい、予測困難なワークロード

### 2. EC2

```
+----------------------------------+
|          ECS on EC2              |
|  +--------------------------+    |
|  |      EC2 Instance        |    |
|  |  +-------+  +-------+    |    |
|  |  | Task  |  | Task  |    |    |
|  |  +-------+  +-------+    |    |
|  |       ECS Agent          |    |
|  +--------------------------+    |
+----------------------------------+
```

- **フルコントロール** - インスタンスタイプ, AMI, ネットワーク設定を制御
- **GPU/特殊ハードウェア** - GPUインスタンス等の特殊要件に対応
- **コスト最適化** - リザーブドインスタンス, スポットインスタンス活用可能
- **既存投資の活用** - Savings Plans適用可能

**ユースケース**: 細かい制御が必要、特殊なハードウェア要件、コスト最適化重視

### 3. External (ECS Anywhere)

後述の「ECS Anywhere」セクションを参照。

---

## Fargate vs EC2 比較

| 項目 | Fargate | EC2 |
|------|---------|-----|
| インフラ管理 | 不要 | 必要 |
| スケーリング | 自動 | Auto Scaling Group設定 |
| 料金モデル | タスク単位 | インスタンス単位 |
| GPU対応 | 非対応 | 対応 |
| スポットインスタンス | Fargate Spot | EC2 Spot |
| 起動速度 | やや遅い | 高速 (インスタンス起動済みの場合) |
| カスタマイズ | 制限あり | フルコントロール |

---

## タスク定義 (Task Definition)

コンテナの設定をJSON形式で定義。

### 主要パラメータ

```json
{
  "family": "my-app",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "256",
  "memory": "512",
  "containerDefinitions": [
    {
      "name": "app",
      "image": "123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/my-app:latest",
      "portMappings": [
        {
          "containerPort": 80,
          "protocol": "tcp"
        }
      ],
      "environment": [
        { "name": "ENV", "value": "production" }
      ],
      "secrets": [
        {
          "name": "DB_PASSWORD",
          "valueFrom": "arn:aws:secretsmanager:..."
        }
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/my-app",
          "awslogs-region": "ap-northeast-1",
          "awslogs-stream-prefix": "ecs"
        }
      }
    }
  ]
}
```

### ネットワークモード

| モード | 説明 | Fargate |
|--------|------|---------|
| **awsvpc** | タスクごとにENIを割り当て | 必須 |
| **bridge** | Dockerのブリッジネットワーク | 非対応 |
| **host** | ホストのネットワークを共有 | 非対応 |
| **none** | ネットワーク無効 | 非対応 |

---

## ECS Service

### 機能

- **Desired Count維持** - 指定した数のタスクを常に維持
- **ローリングアップデート** - 無停止でのデプロイ
- **ロードバランサー統合** - ALB/NLBとの連携
- **Auto Scaling** - メトリクスに基づくスケーリング
- **サービスディスカバリ** - Cloud Mapとの統合

### デプロイ戦略

| 戦略 | 説明 |
|------|------|
| **Rolling Update** | 段階的に新バージョンに置き換え (デフォルト) |
| **Blue/Green (CodeDeploy)** | 新環境を作成してトラフィックを切り替え |

### Auto Scaling

```
+-------------------------------------------+
|          Service Auto Scaling             |
|                                           |
|  +---------------+   +----------------+   |
|  |Target Tracking|   |Step Scaling    |   |
|  |  CPU 70%維持  |   | 閾値ベース      |   |
|  +---------------+   +----------------+   |
|                                           |
|  +------------------------------------+   |
|  |        Scheduled Scaling           |   |
|  |     時間ベースでスケール            |   |
|  +------------------------------------+   |
+-------------------------------------------+
```

---

## IAMロール

### タスク実行ロール (Execution Role)

**ECSエージェントが使用するロール**

- ECRからイメージをプル
- CloudWatch Logsへログ送信
- Secrets Manager / Parameter Storeからシークレット取得

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ecr:GetAuthorizationToken",
        "ecr:BatchGetImage",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "*"
    }
  ]
}
```

### タスクロール (Task Role)

**コンテナ内のアプリケーションが使用するロール**

- S3へのアクセス
- DynamoDBへのアクセス
- 他のAWSサービスへのアクセス

```
+--------------------------------------+
|              ECS Task                |
|  +-------------------------------+   |
|  |     Container (アプリ)         |   |
|  |        |                      |   |
|  |        v Task Role            |   |
|  |    +----------------+         |   |
|  |    | S3, DynamoDB等 |         |   |
|  |    +----------------+         |   |
|  +-------------------------------+   |
|                                      |
|  ECS Agent <- Execution Role         |
+--------------------------------------+
```

---

## データボリューム

### Fargate で使用可能

| タイプ | 説明 | 永続性 |
|--------|------|--------|
| **Ephemeral Storage** | タスクのライフサイクルに紐づく一時ストレージ | なし |
| **EFS** | 複数タスク間で共有可能なファイルシステム | あり |

### EC2 で追加使用可能

| タイプ | 説明 |
|--------|------|
| **Docker Volume** | EC2インスタンス上のDockerボリューム |
| **Bind Mount** | ホストのディレクトリをマウント |

---

## ロードバランサー統合

### ALB (Application Load Balancer)

- **動的ポートマッピング** - 複数タスクを同一インスタンスで実行可能
- **パスベースルーティング** - URLパスに基づく振り分け
- **ホストベースルーティング** - ホスト名に基づく振り分け

### NLB (Network Load Balancer)

- **超低レイテンシー** - L4レベルでの負荷分散
- **静的IP** - 固定IPアドレスが必要な場合
- **TCP/UDP対応** - HTTP以外のプロトコル

---

## ECS Anywhere

オンプレミスやエッジ環境でECSを使用してコンテナワークロードを実行・管理できる機能。

### アーキテクチャ

```
+-------------------------------------------+
|             AWS Cloud                     |
|  +-------------------------------------+  |
|  |        ECS Control Plane            |  |
|  |   (タスクスケジューリング、管理)      |  |
|  +-------------------------------------+  |
+-------------------------------------------+
                  |
                  | SSM Agent経由で接続
                  v
+-------------------------------------------+
|       オンプレミス / エッジ環境            |
|  +-----------+ +-----------+ +-----------+|
|  | Container | | Container | | Container ||
|  +-----------+ +-----------+ +-----------+|
|       ECS Agent + SSM Agent               |
+-------------------------------------------+
```

### 特徴

| 特徴 | 説明 |
|------|------|
| **ハイブリッド管理** | クラウドとオンプレミスを単一コンソールで管理 |
| **EXTERNAL起動タイプ** | EC2/Fargateとは別カテゴリとして扱われる |
| **一貫したAPI** | 同じECS API, CLI, コンソールを使用 |
| **同じタスク定義** | クラウドと同じ形式のタスク定義が使用可能 |

### ユースケース

| ユースケース | 説明 |
|-------------|------|
| **データレジデンシー** | 法規制でデータをオンプレミスに保持する必要がある |
| **低レイテンシー要件** | エッジでのリアルタイム処理が必要 |
| **既存インフラ活用** | オンプレミスサーバーを継続利用 |
| **段階的クラウド移行** | ハイブリッド構成での移行ステップ |

### 前提条件

- SSM Agent のインストール
- ECS Agent のインストール
- AWSへのアウトバウンド接続 (HTTPS)

### 料金

- ECS Anywhere自体の追加料金は**なし**
- 外部インスタンス: **$0.01025/時間/インスタンス**

---

## ECS vs EKS

| 項目 | ECS | EKS |
|------|-----|-----|
| オーケストレーター | AWS独自 | Kubernetes |
| 学習コスト | 低い | 高い |
| ポータビリティ | AWS依存 | マルチクラウド可能 |
| 料金 | 無料 (インフラのみ) | $0.10/時間/クラスター |
| エコシステム | AWS統合が強い | K8sエコシステム活用 |

---

## SAA試験のポイント

### 頻出トピック

1. **Fargate vs EC2の選択**
   - 運用負荷削減 -> Fargate
   - GPU必要、コスト最適化 -> EC2
   - スポット活用 -> 両方可能

2. **IAMロールの違い**
   - Execution Role: ECSエージェント用 (ECR, CloudWatch Logs)
   - Task Role: アプリケーション用 (S3, DynamoDB等)

3. **ネットワークモード**
   - Fargateは **awsvpc必須**
   - タスクごとにENIが割り当てられる

4. **ECS Anywhere**
   - オンプレミスでECSを使う
   - EXTERNAL起動タイプ
   - SSM Agent必須

5. **データ永続化**
   - Fargateで永続化 -> **EFS** を使用
   - タスク間でデータ共有 -> **EFS**

6. **スケーリング**
   - Service Auto Scaling (タスク数)
   - EC2の場合はCapacity Provider + Auto Scaling Group

### よくある問題パターン

| シナリオ | 解答 |
|---------|------|
| 運用負荷を最小化してコンテナ実行 | Fargate |
| オンプレミスでコンテナをAWSで管理 | ECS Anywhere |
| コンテナからS3にアクセス | Task Role |
| ECRからイメージをプル | Execution Role |
| タスク間でファイル共有 | EFS |
| GPUでML推論 | EC2起動タイプ |
