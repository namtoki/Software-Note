# Amazon EC2 (Elastic Compute Cloud)

```
+------------------------------------------------------------------+
|                        Amazon EC2                                |
|  +------------------------------------------------------------+  |
|  |                      EC2 Instance                          |  |
|  |  +------------------+  +------------------+                |  |
|  |  |     vCPU         |  |     Memory       |                |  |
|  |  +------------------+  +------------------+                |  |
|  |  +------------------+  +------------------+                |  |
|  |  | Instance Store   |  |    EBS Volume    |                |  |
|  |  | (ephemeral)      |  |   (persistent)   |                |  |
|  |  +------------------+  +------------------+                |  |
|  |  +----------------------------------------------+          |  |
|  |  |              Network Interface (ENI)         |          |  |
|  |  +----------------------------------------------+          |  |
|  +------------------------------------------------------------+  |
+------------------------------------------------------------------+
```

## Functions
- Instance:
  - Instance type:
    - ```txt
      m   5   d   .   xlarge
      |   |   |       |
      |   |   |       +-- サイズ (nano, micro, small, medium, large, xlarge, 2xlarge...)
      |   |   +-- 追加機能 (d=NVMe SSD, n=ネットワーク強化, a=AMD, g=Graviton...)
      |   +-- 世代番号
      +-- ファミリー (汎用, コンピューティング最適化, メモリ最適化...)
      ```
      | ファミリー | 用途 | ユースケース |
      |-----------|------|-------------|
      | T (T3, T3a, T4g) | バースト可能汎用 | 開発環境、小規模Web、マイクロサービス |
      | M (M5, M6i, M7g) | 汎用 | Webサーバー、アプリサーバー、エンタープライズアプリ |
      | `C (C5, C6i, C7g)` | `コンピューティング最適化` | バッチ処理、ゲームサーバー、科学計算 |
      | `R (R5, R6i, R7g)` | `メモリ最適化` | インメモリDB、リアルタイム分析、SAP HANA |
      | X (X1, X2idn) | 大容量メモリ | SAP HANA、大規模インメモリDB |
      | I (I3, I4i) | ストレージ最適化 | NoSQL DB、データウェアハウス |
      | D (D2, D3) | 高密度ストレージ | 分散ファイルシステム、Hadoop |
      | P (P3, P4, P5) | GPU (汎用) | 機械学習、ディープラーニング |
      | G (G4, G5) | GPU (グラフィックス) | ゲームストリーミング、3Dレンダリング |
      | Inf (Inf1, Inf2) | 推論最適化 | 機械学習推論 (AWS Inferentia) |
      | Trn (Trn1) | 学習最適化 | 機械学習トレーニング (AWS Trainium) |
      | HPC (Hpc6a, Hpc7g) | HPC最適化 | 高性能コンピューティング |
  - Plans:
    - `On-Demand Instance`:             使った分秒単位 (最低60秒) 課金 / 前払い・長期契約なし / いつでも起動・停止可能
    - `Reserved Instance (RI)`:         (1 or 3 年) / 全額前払い, 一部前払い, 前払いなし / 24/7 稼働、予測可能
      - type:
        - `Standard RI`:                最大72%割引 / インスタンスタイプ固定 / Marketplace リセール可能
        - `Convertible RI`:             最大66%割引 / インスタンスタイプ変更可能 / Marketplace リセール不可
      - option:
        - 全前払い (All Upfront)
        - 一部前払い (Partial Upfront)
        - 前払いなし (No Upfront)
    - `Saving Plans`:
      - `Compute Savings Plans`:        最大66%割引 / ファミリー,リージョン自由 / Fargate/Lambda にも適用
      - `EC2 Instance Savings`:         最大72%割引 / ファミリー固定 / リージョン固定
    - `Spot Instance`:                  最大90%割引 / AWS が回収可能 (2分前通知) / 余剰キャパシティを大幅な割引で使用
      - Spot Fleet 戦略:
        - lowestPrice:                最安のプールから起動 (デフォルト)
        - diversified                 複数プールに分散 (可用性向上)
        - capacityOptimized           容量が最も確保しやすいプールから起動
        - priceCapacityOptimized      価格と容量のバランス (推奨)
    - `Dedicated Host`:                 物理サーバー==専有== / ソケット・コア可視 / ==BYOL対応== / ライセンス要件向け
    - `Dedicated Instance`:             ハードウェア分離 / ==他アカウントと共有しないだけ== / BYOL不可
    - `EC2 Fleet`:                      複数の購入オプションとインスタンスタイプを組み合わせ
  - Components:
    - `AMI`:                            リージョン固有 / 他リージョンにコピー可 / 他アカウントに共有可
      - EBS-backed:                   停止/起動可能 (一般的)
      - Instance Store-backed:        停止不可 (terminate のみ)
    - Storage:
      - `EBS`:                          永続的 / ネットワーク接続 / スナップショット可 / AZ固有
        - gp3:                        汎用SSD (デフォルト推奨)
        - io2:                        高IOPS (DB向け)
        - st1:                        スループット最適化HDD (ビッグデータ)
        - sc1:                        コールドHDD (アーカイブ)
        - Multi-Attach:               io1/io2のみ / 同一AZ内で複数インスタンスにアタッチ
      - `Instance Store`:               一時的 (停止/終了で消失) / 物理接続で高速 / バッファ,キャッシュ向け

  - `Amazon Elastic Load Balancing`         レイヤ7

---

## ネットワーキング

### ENI (Elastic Network Interface)

```
+------------------------------------------------------------------+
|                    EC2 Instance                                   |
|  +-----------------------------+  +----------------------------+  |
|  |        Primary ENI          |  |      Secondary ENI         |  |
|  |  - プライベート IP          |  |  - 追加 IP                 |  |
|  |  - パブリック IP (option)   |  |  - 別サブネット可          |  |
|  |  - セキュリティグループ      |  |  - フェイルオーバー用      |  |
|  +-----------------------------+  +----------------------------+  |
+------------------------------------------------------------------+
```

### ENI タイプ

| タイプ | 説明 |
|-------|------|
| **ENI** | 標準的なネットワークインターフェース |
| **ENA (Elastic Network Adapter)** | 拡張ネットワーキング (最大100Gbps) |
| **EFA (Elastic Fabric Adapter)** | HPC 向け低レイテンシーネットワーク |

### IP アドレス

| タイプ | 説明 | 課金 |
|-------|------|------|
| **プライベート IP** | VPC 内通信用 | 無料 |
| **パブリック IP** | インターネット通信用 (動的) | 2024年2月から課金 |
| **Elastic IP** | 静的パブリック IP | 使用中は無料、未使用は課金 |

### Elastic IP

```
+------------------------------------------+
|            Elastic IP                     |
|  +------------------------------------+  |
|  | - 静的 IPv4 アドレス               |  |
|  | - アカウントに紐づく               |  |
|  | - インスタンス間で付け替え可能     |  |
|  | - リージョンあたり5つまで (default)|  |
|  +------------------------------------+  |
+------------------------------------------+
```

### 拡張ネットワーキング

| 機能 | 説明 |
|------|------|
| **ENA** | 最大100Gbps のネットワーク帯域 |
| **SR-IOV** | シングルルート I/O 仮想化 |
| **Placement Group** | インスタンス配置の最適化 |

---

## Placement Group (配置グループ)

### タイプ

```
+------------------------------------------------------------------+
|                    Placement Group                                |
|                                                                  |
|  +------------------+ +------------------+ +------------------+   |
|  |    Cluster       | |     Spread       | |    Partition     |   |
|  |   [][][][][]     | |  []    []    []  | |  [A][A] [B][B]   |   |
|  |   低レイテンシー  | |  高可用性        | |  分散処理        |   |
|  +------------------+ +------------------+ +------------------+   |
+------------------------------------------------------------------+
```

| タイプ | 説明 | ユースケース |
|-------|------|-------------|
| **Cluster** | 同一 AZ の近接ハードウェアに配置 | HPC、低レイテンシーが必要なアプリ |
| **Spread** | 異なるハードウェアに分散 (AZ あたり7インスタンス) | 高可用性が必要なアプリ |
| **Partition** | パーティション単位で分離 | 大規模分散処理 (Hadoop, Cassandra) |

---

## セキュリティ

### セキュリティグループ

```
+------------------------------------------------------------------+
|                   Security Group                                  |
|  +------------------------------------------------------------+  |
|  |  インバウンドルール    | アウトバウンドルール                |  |
|  |  (デフォルト: 全拒否)  | (デフォルト: 全許可)                |  |
|  +------------------------------------------------------------+  |
|  | - 許可ルールのみ (拒否不可)                                  |  |
|  | - ステートフル (戻りトラフィック自動許可)                    |  |
|  | - インスタンスレベルで適用                                  |  |
|  | - 複数 SG をアタッチ可能                                    |  |
|  +------------------------------------------------------------+  |
+------------------------------------------------------------------+
```

### キーペア

| 項目 | 説明 |
|------|------|
| **Linux** | SSH 接続用 (秘密鍵で認証) |
| **Windows** | Administrator パスワード復号用 |
| **形式** | RSA (2048/4096) または ED25519 |

### IAM ロール

```
+------------------------------------------+
|            EC2 Instance                   |
|  +------------------------------------+  |
|  |  Instance Profile                  |  |
|  |  +------------------------------+  |  |
|  |  |       IAM Role               |  |  |
|  |  |  - S3 アクセス               |  |  |
|  |  |  - DynamoDB アクセス         |  |  |
|  |  |  - その他 AWS サービス       |  |  |
|  |  +------------------------------+  |  |
|  +------------------------------------+  |
+------------------------------------------+
```

- EC2 から AWS サービスへのアクセスには IAM ロールを使用
- アクセスキーをインスタンスに保存しない
- Instance Profile を通じてロールをアタッチ

---

## User Data とメタデータ

### User Data

インスタンス起動時に実行されるスクリプト。

```bash
#!/bin/bash
yum update -y
yum install -y httpd
systemctl start httpd
systemctl enable httpd
echo "Hello from $(hostname)" > /var/www/html/index.html
```

| 特徴 | 説明 |
|------|------|
| **実行タイミング** | 初回起動時のみ (デフォルト) |
| **サイズ制限** | 16KB (Base64 エンコード前) |
| **実行ユーザー** | root |

### インスタンスメタデータ (IMDS)

```bash
# IMDSv2 (推奨)
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")

curl -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/

# 取得可能な情報
# - instance-id
# - ami-id
# - instance-type
# - public-ipv4
# - iam/security-credentials/<role-name>
```

| バージョン | 特徴 |
|-----------|------|
| **IMDSv1** | シンプルな GET リクエスト (非推奨) |
| **IMDSv2** | トークンベース、よりセキュア (推奨) |

---

## Auto Scaling

### コンポーネント

```
+------------------------------------------------------------------+
|                     Auto Scaling                                  |
|  +------------------------------------------------------------+  |
|  |               Launch Template / Launch Configuration        |  |
|  |  (AMI, インスタンスタイプ, セキュリティグループ, etc.)       |  |
|  +------------------------------------------------------------+  |
|                              |                                    |
|                              v                                    |
|  +------------------------------------------------------------+  |
|  |                  Auto Scaling Group (ASG)                   |  |
|  |  +------------------+  +------------------+                 |  |
|  |  | 最小サイズ: 2    |  | 希望サイズ: 4    |                 |  |
|  |  +------------------+  +------------------+                 |  |
|  |  +------------------+                                       |  |
|  |  | 最大サイズ: 10   |                                       |  |
|  |  +------------------+                                       |  |
|  +------------------------------------------------------------+  |
|                              |                                    |
|                              v                                    |
|  +------------------------------------------------------------+  |
|  |                   Scaling Policies                          |  |
|  |  Target Tracking / Step / Simple / Scheduled / Predictive  |  |
|  +------------------------------------------------------------+  |
+------------------------------------------------------------------+
```

### Launch Template vs Launch Configuration

| 項目 | Launch Template | Launch Configuration |
|------|-----------------|---------------------|
| バージョニング | Yes | No |
| 複数インスタンスタイプ | Yes | No |
| Spot/オンデマンド混在 | Yes | No |
| T2/T3 Unlimited | Yes | No |
| 推奨 | Yes | No (非推奨) |

### スケーリングポリシー

| ポリシー | 説明 | ユースケース |
|---------|------|-------------|
| **Target Tracking** | メトリクスを目標値に維持 | CPU 使用率を 50% に維持 |
| **Step Scaling** | 閾値に応じて段階的にスケール | アラーム単位で細かく制御 |
| **Simple Scaling** | 単一の閾値でスケール | シンプルな要件 |
| **Scheduled** | 時間ベースでスケール | 予測可能な負荷パターン |
| **Predictive** | ML で予測してスケール | 周期的なパターン |

### スケーリングクールダウン

| 項目 | 説明 |
|------|------|
| **デフォルト** | 300秒 (5分) |
| **目的** | 連続スケーリングを防止 |
| **設定** | スケールイン/アウト個別に設定可能 |

### ライフサイクルフック

```
+------------------------------------------------------------------+
|                  Lifecycle Hooks                                  |
|                                                                  |
|  Pending:Wait -----> Pending:Proceed -----> InService            |
|      |                                          |                |
|      v                                          v                |
|  (カスタム処理)                           Terminating:Wait       |
|  - ソフトウェア設定                            |                 |
|  - 設定ダウンロード                            v                 |
|                                          (カスタム処理)          |
|                                          - ログ退避             |
|                                          - 登録解除             |
+------------------------------------------------------------------+
```

### Warm Pool

事前にウォームアップしたインスタンスをプール。

```
+------------------------------------------+
|              Warm Pool                    |
|  +----------+ +----------+ +----------+  |
|  | Stopped  | | Stopped  | | Running  |  |
|  | Instance | | Instance | | Instance |  |
|  +----------+ +----------+ +----------+  |
|       スケールアウト時に即座に使用可能     |
+------------------------------------------+
```

---

## ハイバネーション

### 概要

```
+------------------------------------------------------------------+
|                     Hibernation                                   |
|  +------------------------------------------------------------+  |
|  |  1. メモリ内容を EBS ルートボリュームに保存                   |  |
|  |  2. インスタンス停止                                        |  |
|  |  3. 再起動時にメモリを復元                                   |  |
|  |  4. アプリケーションが中断したところから再開                  |  |
|  +------------------------------------------------------------+  |
+------------------------------------------------------------------+
```

### 要件

| 要件 | 説明 |
|------|------|
| **ルートボリューム** | EBS、暗号化必須 |
| **ルートボリュームサイズ** | メモリサイズ以上 |
| **インスタンスサイズ** | 150GB 未満の RAM |
| **ハイバネーション期間** | 最大60日 |

---

## 監視とトラブルシューティング

### CloudWatch メトリクス

| メトリクス | 説明 | デフォルト間隔 |
|-----------|------|--------------|
| **CPUUtilization** | CPU 使用率 | 5分 |
| **NetworkIn/Out** | ネットワークトラフィック | 5分 |
| **DiskReadOps/WriteOps** | ディスク操作 | 5分 |
| **StatusCheckFailed** | ステータスチェック | 1分 |

**詳細モニタリング:** 1分間隔 (追加料金)

### ステータスチェック

| チェック | 対象 | 失敗時の対応 |
|---------|------|-------------|
| **System Status Check** | AWS インフラ | インスタンス停止/起動 |
| **Instance Status Check** | OS/ネットワーク | インスタンス再起動 |

### EC2 Instance Connect

ブラウザまたは CLI から SSH 接続。

```bash
# CLI から接続
aws ec2-instance-connect send-ssh-public-key \
  --instance-id i-1234567890abcdef0 \
  --instance-os-user ec2-user \
  --ssh-public-key file://my-key.pub
```

### Systems Manager Session Manager

```
+------------------------------------------+
|        Session Manager                    |
|  +------------------------------------+  |
|  | - SSH キー不要                     |  |
|  | - ポート 22 不要                   |  |
|  | - 監査ログ (CloudWatch/S3)        |  |
|  | - IAM ベースのアクセス制御         |  |
|  +------------------------------------+  |
+------------------------------------------+
```

---

## SAA 試験のポイント

### 頻出トピック

#### 4. 高可用性

| シナリオ | 推奨 |
|---------|------|
| 単一障害点の排除 | Spread Placement Group |
| 低レイテンシー通信 | Cluster Placement Group |
| 自動復旧 | Auto Scaling + 複数 AZ |

#### 5. セキュリティ

| シナリオ | 推奨 |
|---------|------|
| AWS サービスへのアクセス | IAM ロール (アクセスキー禁止) |
| SSH 接続のセキュア化 | Session Manager or EC2 Instance Connect |
| メタデータ保護 | IMDSv2 必須化 |

### よくある問題パターン

| シナリオ | 解答 |
|---------|------|
| CPU 使用率を 70% に維持したい | Target Tracking Scaling Policy |
| インスタンスから S3 にアクセス | IAM ロールをアタッチ |
| Spot 中断に備えたい | Spot Fleet (diversified) |
| ステートフルアプリのスケーリング | ライフサイクルフック |
| 起動時間を短縮したい | Warm Pool |
| 停止後もデータを保持したい | EBS ボリューム |
| 高速な一時ストレージが必要 | Instance Store |
| Windows ライセンス持ち込み | Dedicated Host |
| 毎朝9時に負荷増加 | Scheduled Scaling |
| インスタンス間で EBS 共有 | io2 + Multi-Attach |
| EC2 のステータス監視 | ステータスチェックアラーム |


| **EC2 Image Builder** | AMI 自動作成 |
