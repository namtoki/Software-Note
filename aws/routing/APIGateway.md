# Amazon API Gateway

- `Amazon API Gateway`                      API 管理サービス / 開発者が RESTful API、HTTP API、WebSocket API を簡単に作成、公開、保守、監視、保護

API の作成、公開、管理、監視、保護を行うフルマネージドサービス。

```
+-------------+       +------------------+       +-------------------+
|   Client    | ----> |   API Gateway    | ----> |   Backend         |
| - Browser   |       |   - REST API     |       |   - Lambda        |
| - Mobile    |       |   - HTTP API     |       |   - EC2/ECS       |
| - IoT       |       |   - WebSocket    |       |   - Any HTTP      |
+-------------+       +------------------+       +-------------------+
                              |
                              v
                      +----------------+
                      | - 認証/認可    |
                      | - スロットリング|
                      | - キャッシュ   |
                      | - 変換        |
                      +----------------+
```

## Functions
- `REST API`:                       ==従来型== / 機能豊富 / API キー、使用量プラン、リクエスト検証
- `HTTP API`:                       ==低コスト・低レイテンシー== / REST API より最大70%安価 / シンプルなプロキシ向け
- `WebSocket API`:                  双方向リアルタイム通信 / チャット、ゲーム、金融ティッカー
- `エンドポイントタイプ`:
  - `Regional`:                     同一リージョンのクライアント向け
  - `Edge-Optimized`:               ==CloudFront経由== / グローバルクライアント向け (デフォルト)
  - `Private`:                      ==VPC内からのみ== / VPCエンドポイント経由でアクセス
- `ステージ`:                       dev, staging, prod などの環境分離 / ステージ変数でパラメータ化
- `キャッシュ`:                     ==$0.02〜$3.80/時間== / 0.5GB〜237GB / TTL 0〜3600秒 / バックエンド負荷軽減

## 認証・認可

| 方式 | 説明 | ユースケース |
|------|------|-------------|
| IAM | AWS署名v4 | AWS内部/サーバー間通信 |
| Cognito User Pools | JWTトークン | モバイル/Webアプリユーザー認証 |
| Lambda Authorizer | カスタム認証ロジック | 独自トークン、サードパーティ認証 |
| API Key | シンプルなキー認証 | 使用量制限・課金用 (認証には不十分) |

## 料金

### REST API
- `API呼び出し`:                    ==$3.50/100万リクエスト== (最初の3.33億)
- `キャッシュ`:                     $0.02〜$3.80/時間 (サイズ別)
- `データ転送`:                     標準AWS転送料金

### HTTP API
- `API呼び出し`:                    ==$1.00/100万リクエスト== (最初の3億)
- ==REST APIより最大70%安価==

### WebSocket API
- `メッセージ`:                     $1.00/100万メッセージ
- `接続時間`:                       $0.25/100万接続分

---

## REST API vs HTTP API

| 項目 | REST API | HTTP API |
|------|----------|----------|
| 料金 | 高い | ==最大70%安価== |
| レイテンシー | 標準 | ==低い== |
| API キー・使用量プラン | あり | なし |
| リクエスト検証 | あり | なし |
| キャッシュ | あり | なし |
| WAF統合 | あり | なし |
| Lambda Authorizer | あり | あり |
| Cognito | あり | あり (JWT) |
| プライベートエンドポイント | あり | なし |

**選択指針**:
- 機能重視 → REST API
- コスト・シンプルさ重視 → HTTP API

---

## 統合タイプ

| タイプ | 説明 |
|-------|------|
| Lambda | Lambda関数を直接呼び出し |
| HTTP | 任意のHTTPエンドポイント |
| AWS Service | AWSサービスを直接呼び出し (S3, DynamoDB, Step Functions等) |
| Mock | バックエンドなしでレスポンス返却 (テスト用) |
| VPC Link | VPC内のリソース (ALB, NLB, EC2) に接続 |

---

## スロットリング

```
+------------------+
| アカウント上限    |  10,000 req/sec (リージョン全体)
+------------------+
         |
+------------------+
| ステージ上限      |  ステージごとに設定可能
+------------------+
         |
+------------------+
| メソッド上限      |  メソッドごとに設定可能
+------------------+
```

- デフォルト: **10,000 リクエスト/秒** (リージョン単位)
- バースト: **5,000 リクエスト**
- 超過時: **429 Too Many Requests** を返却
- 使用量プランで API キー単位の制限も可能

---

## CORS (Cross-Origin Resource Sharing)

- ブラウザからの異なるオリジンへのリクエストを許可
- **REST API**: コンソールでワンクリック設定 or 手動で OPTIONS メソッド追加
- **HTTP API**: 簡単な設定で自動構成
- Lambda統合の場合、Lambda側でもCORSヘッダー返却が必要

---

## 連携サービス

| サービス | 連携内容 |
|---------|---------|
| Lambda | サーバーレスバックエンド |
| Cognito | ユーザー認証 |
| WAF | Webアプリケーションファイアウォール (REST APIのみ) |
| CloudWatch | ログ、メトリクス、アラーム |
| X-Ray | 分散トレーシング |
| ACM | カスタムドメインのSSL証明書 |

---

## SAA試験 頻出ポイント

### 選択シナリオ

| シナリオ | 解答 |
|---------|------|
| Lambda の前段に API を置きたい | API Gateway |
| 低コストでシンプルな API | HTTP API |
| API キー・使用量プランが必要 | REST API |
| リアルタイム双方向通信 | WebSocket API |
| VPC内のみからアクセス | Private エンドポイント |
| グローバルユーザー向け | Edge-Optimized エンドポイント |
| バックエンド負荷軽減 | キャッシュ有効化 |
| DDoS/SQLインジェクション対策 | WAF + REST API |

### 認証の使い分け

| シナリオ | 解答 |
|---------|------|
| モバイルアプリのユーザー認証 | Cognito User Pools |
| AWS内部のサービス間通信 | IAM認証 |
| 独自の認証システムと連携 | Lambda Authorizer |
| サードパーティ開発者への公開 | API キー + 使用量プラン |

### 重要ポイント

- **スロットリング**: 429エラー → リクエスト制限超過
- **キャッシュ**: バックエンド負荷軽減、レイテンシー改善
- **ステージ**: 環境分離 (dev/staging/prod)
- **VPC Link**: プライベートリソースへの接続
- **WAF統合**: REST API のみ (HTTP APIは非対応)
