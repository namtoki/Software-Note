# AWS Config

AWS リソースの**構成を記録・評価**するサービス。

## 概要

```
AWS リソース
    |
    v
AWS Config が構成を記録
    |
    +---> 構成履歴（いつ、何が変わったか）
    +---> 構成スナップショット（ある時点の全体像）
    +---> Config Rules（ルール違反を検知）
```

## CloudTrail との違い

| 項目 | CloudTrail | AWS Config |
|------|-----------|------------|
| 記録対象 | **API コール（誰が何をしたか）** | **リソースの構成（どうなっているか）** |
| 例 | 誰がセキュリティグループを変更した？ | セキュリティグループの現在の設定は？ |
| 履歴 | API コールの履歴 | 構成変更の履歴 |

```
例: セキュリティグループの変更

CloudTrail: 「ユーザーAが AuthorizeSecurityGroupIngress を実行した」
AWS Config: 「ポート22が 0.0.0.0/0 から許可された状態になった」
```

## 主な機能

### 1. 構成の記録

- リソースの構成変更を**継続的に記録**
- **構成履歴**: 過去の構成を確認可能
- **構成スナップショット**: 定期的に全リソースの状態を保存

### 2. Config Rules（構成ルール）

リソースが**ルールに準拠しているか**を評価。

```
Config Rule の例:
「セキュリティグループで 0.0.0.0/0 からの SSH を許可していないこと」

評価結果:
  sg-aaa: COMPLIANT（準拠）
  sg-bbb: NON_COMPLIANT（違反）← アラート
```

#### ルールの種類

| 種類 | 説明 |
|------|------|
| **AWS マネージドルール** | AWS が提供する事前定義ルール（150以上） |
| **カスタムルール** | Lambda で独自ロジックを実装 |

#### よく使われるマネージドルール

| ルール名 | 評価内容 |
|----------|----------|
| `s3-bucket-public-read-prohibited` | S3 バケットがパブリック読み取り禁止か |
| `s3-bucket-ssl-requests-only` | S3 が HTTPS のみ許可しているか |
| `encrypted-volumes` | EBS ボリュームが暗号化されているか |
| `ec2-instance-managed-by-ssm` | EC2 が SSM で管理されているか |
| `restricted-ssh` | SSH が 0.0.0.0/0 から許可されていないか |
| `rds-instance-public-access-check` | RDS がパブリックアクセス禁止か |
| `root-account-mfa-enabled` | root アカウントで MFA が有効か |
| `iam-password-policy` | IAM パスワードポリシーが要件を満たすか |

#### 評価トリガー

| トリガー | 説明 |
|----------|------|
| **構成変更時** | リソースが変更されたときに評価 |
| **定期的** | 1時間、3時間、6時間、12時間、24時間ごと |

### 3. 自動修復（Remediation）

ルール違反を**自動的に修復**。

```
Config Rule（違反検知）
    |
    v
SSM Automation ドキュメント
    |
    v
自動修復（例: パブリックアクセスを無効化）
```

#### 修復の種類

| 種類 | 説明 |
|------|------|
| **手動修復** | 違反を通知、手動で対応 |
| **自動修復** | SSM Automation で自動対応 |

### 4. 適合パック（Conformance Packs）

複数の Config Rules を**パッケージ化**。

```
適合パック例: 「PCI DSS」
├── encrypted-volumes
├── s3-bucket-ssl-requests-only
├── restricted-ssh
├── ...（複数のルールをまとめて適用）
```

コンプライアンス要件（PCI DSS、HIPAA など）に対応したパックを提供。

### 5. アグリゲータ（Aggregator）

複数アカウント・リージョンの Config データを**集約**。

```
┌─────────────────────────────────────┐
│  集約アカウント                      │
│  ┌─────────────────────────────┐    │
│  │ Config Aggregator           │    │
│  │ （全体のコンプライアンス状況）  │    │
│  └─────────────────────────────┘    │
│         ^    ^    ^                 │
└─────────│────│────│─────────────────┘
          │    │    │
     ┌────┘    │    └────┐
     │         │         │
アカウントA  アカウントB  アカウントC
```

## 保存先

| データ | 保存先 |
|--------|--------|
| 構成履歴 | S3 バケット |
| 構成スナップショット | S3 バケット |
| 変更通知 | SNS トピック（オプション） |

## 料金

| 項目 | 料金 |
|------|------|
| 構成項目の記録 | $0.003 / 構成項目 |
| Config Rules 評価 | $0.001 / 評価 |
| 適合パック評価 | $0.001 / 評価 |

## Organizations 連携

- **組織全体で Config を有効化**
- **組織の適合パック**: 全アカウントに一括適用
- **組織のアグリゲータ**: 全アカウントのデータを集約

## 試験頻出ポイント

- **構成の変更履歴**を確認したい → AWS Config
- **ルールに準拠しているか**評価したい → Config Rules
- **違反を自動修復**したい → Config Rules + SSM Automation
- **コンプライアンス要件**への対応 → 適合パック
- **複数アカウント集約** → アグリゲータ
- CloudTrail は「誰が」、Config は「どうなっているか」

## 試験シナリオ

| シナリオ | 答え |
|----------|------|
| セキュリティグループの変更履歴を確認したい | AWS Config |
| S3 がパブリックになっていないか監視したい | Config Rules（s3-bucket-public-read-prohibited） |
| EBS が暗号化されているか確認したい | Config Rules（encrypted-volumes） |
| 違反リソースを自動で修復したい | Config Rules + 自動修復 |
| 全アカウントのコンプライアンス状況を一覧したい | Config アグリゲータ |
| PCI DSS 準拠を確認したい | 適合パック |
| 誰がリソースを変更したか知りたい | CloudTrail（Config ではない） |
