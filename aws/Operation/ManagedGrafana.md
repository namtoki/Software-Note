# Amazon Managed Grafana / Prometheus

AWSが提供するフルマネージド型のモニタリング・可視化サービス。

## サービス概要

| サービス | 略称 | 役割 |
|---------|------|------|
| Amazon Managed Service for Prometheus | AMP | メトリクス収集・保存・クエリ |
| Amazon Managed Grafana | AMG | ダッシュボード・可視化 |

```
+-------------+      +---------+      +------------------+
| EKS/ECS/EC2 | ---> |   AMP   | ---> |       AMG        |
|  メトリクス  |      | (保存)   |      | (可視化・分析)    |
+-------------+      +---------+      +------------------+
```

---

## Amazon Managed Service for Prometheus (AMP)

Prometheusと互換性のあるフルマネージド型モニタリングサービス。

### アーキテクチャ

```
+---------------------------------------------+
|              AWS Cloud                      |
|  +---------------------------------------+  |
|  | Amazon Managed Service for Prometheus |  |
|  |  +----------+  +------------+         |  |
|  |  |  Ingest  |  |   Query    |         |  |
|  |  +----------+  +------------+         |  |
|  |  +-----------------------------+      |  |
|  |  |    Storage (自動管理)        |      |  |
|  |  +-----------------------------+      |  |
|  +---------------------------------------+  |
+---------------------------------------------+
         ^                    |
         | Remote Write       | PromQL
         |                    v
+----------------+     +------------------+
| Prometheus     |     | Grafana          |
| Grafana Agent  |     | (可視化)          |
| ADOT Collector |     +------------------+
+----------------+
```

### 主な特徴

| 特徴 | 説明 |
|------|------|
| **Prometheus互換** | 既存のPromQLクエリ、ダッシュボードをそのまま使用可能 |
| **フルマネージド** | インフラ管理不要、自動スケーリング |
| **高可用性** | マルチAZ構成で99.9%のSLA |
| **セキュリティ** | AWS PrivateLink、IAM統合、暗号化 |
| **スケーラビリティ** | ワークロードに応じて自動スケール |

### コンポーネント

| コンポーネント | 説明 |
|---------------|------|
| **Workspace** | メトリクスを保存・クエリする論理的な単位 |
| **Remote Write** | Prometheusからメトリクスを送信 (AWS SigV4認証) |
| **Query Endpoint** | PromQLでメトリクスをクエリ |

### データ収集方法

| 方法 | 説明 |
|------|------|
| **Prometheus Server** | 既存のPrometheusからRemote Write |
| **ADOT Collector** | AWS Distro for OpenTelemetry |
| **Grafana Agent** | 軽量なメトリクス収集エージェント |

### 料金

| 項目 | 料金 (東京) |
|------|------------|
| メトリクス取り込み | $0.90 / 1000万サンプル |
| ストレージ | $0.03 / GB-月 |
| クエリ処理 | $0.10 / 10億サンプル |

---

## Amazon Managed Grafana (AMG)

Grafanaと互換性のあるフルマネージド型データ可視化サービス。

### アーキテクチャ

```
+--------------------------------------------------+
|                Amazon Managed Grafana            |
|  +--------------------------------------------+  |
|  |              Workspace                     |  |
|  |  +----------------+  +------------------+  |  |
|  |  | Dashboards     |  | Alerting         |  |  |
|  |  +----------------+  +------------------+  |  |
|  |  +----------------+  +------------------+  |  |
|  |  | Data Sources   |  | User Management  |  |  |
|  |  +----------------+  +------------------+  |  |
|  +--------------------------------------------+  |
+--------------------------------------------------+
              ^
              | データソース接続
+-------------+-------------+-------------+
|  AMP        |  CloudWatch |  X-Ray     |
|  Athena     |  Timestream |  OpenSearch|
+-------------+-------------+-------------+
```

### 主な特徴

| 特徴 | 説明 |
|------|------|
| **Grafana互換** | 既存のGrafanaダッシュボードを移行可能 |
| **フルマネージド** | パッチ適用、バックアップ、スケーリング自動化 |
| **SSO統合** | SAML 2.0、AWS IAM Identity Center対応 |
| **マルチデータソース** | 30以上のデータソースをサポート |
| **セキュリティ** | VPC対応、保存時暗号化 |

### 対応データソース

| カテゴリ | サービス |
|---------|---------|
| **AWS** | CloudWatch, X-Ray, Timestream, Athena, OpenSearch |
| **Prometheus** | AMP, セルフホスト Prometheus |
| **データベース** | MySQL, PostgreSQL, Redshift |
| **その他** | Elasticsearch, InfluxDB, Graphite |

### 認証・認可

| 方法 | 説明 |
|------|------|
| **AWS IAM Identity Center** | 組織のSSOと統合 |
| **SAML 2.0** | 外部IdPとの連携 (Okta, Azure AD等) |
| **サービスアカウント** | API/自動化用 |

### ライセンス

| エディション | 説明 |
|-------------|------|
| **Grafana Enterprise** | エンタープライズプラグイン、サポート付き |
| **Grafana** | オープンソース版相当 |

### 料金

| 項目 | 料金 |
|------|------|
| アクティブエディター | $9.00 / ユーザー-月 |
| アクティブビューワー | $5.00 / ユーザー-月 |

---

## AMP + AMG 統合アーキテクチャ

### コンテナモニタリング構成

```
+------------------+
|      EKS         |
|  +------------+  |
|  | Prometheus |  |     Remote Write
|  | (収集)     |--------------------+
|  +------------+  |                 |
+------------------+                 v
                              +-----------+
+------------------+          |    AMP    |
|      ECS         |          | (保存)    |
|  +------------+  |          +-----------+
|  | ADOT       |------------+      |
|  | Collector  |  |                | PromQL
|  +------------+  |                v
+------------------+          +-----------+
                              |    AMG    |
                              | (可視化)   |
                              +-----------+
                                    |
                              +-----v------+
                              | Dashboard  |
                              | Alerting   |
                              +------------+
```

### マルチアカウント構成

```
+-------------------+  +-------------------+
|   Account A       |  |   Account B       |
|  +-------------+  |  |  +-------------+  |
|  | Prometheus  |  |  |  | Prometheus  |  |
|  +------+------+  |  |  +------+------+  |
+---------|---------+  +---------|---------+
          |                      |
          v                      v
     +------------------------------------+
     |         Central Account            |
     |  +------------------------------+  |
     |  |            AMP               |  |
     |  +------------------------------+  |
     |  +------------------------------+  |
     |  |            AMG               |  |
     |  +------------------------------+  |
     +------------------------------------+
```

---

## CloudWatch との比較

| 項目 | AMP + AMG | CloudWatch |
|------|-----------|------------|
| クエリ言語 | PromQL | CloudWatch Insights |
| 互換性 | OSS互換 (Prometheus/Grafana) | AWS独自 |
| 主な用途 | コンテナ/K8s/マイクロサービス | AWSリソース全般 |
| 既存移行 | Prometheus環境から容易 | 設定変更必要 |
| エコシステム | OSSエコシステム活用 | AWS統合が強い |
| 学習コスト | Prometheus/Grafana経験者は低い | AWS経験者は低い |

---

## ユースケース

| ユースケース | 説明 |
|-------------|------|
| **EKS/ECSモニタリング** | コンテナメトリクスの収集・可視化 |
| **マイクロサービス監視** | 分散システムのパフォーマンス監視 |
| **既存Prometheus移行** | セルフマネージドからマネージドへ |
| **マルチアカウント監視** | 複数AWSアカウントのメトリクス集約 |
| **ハイブリッド環境** | オンプレミス + クラウドの統合監視 |

---

## SAA試験のポイント

### 頻出トピック

1. **AMP vs CloudWatch**
   - Prometheus互換が必要 -> AMP
   - AWSネイティブ監視 -> CloudWatch
   - 既存Prometheusからの移行 -> AMP

2. **AMGの認証**
   - AWS IAM Identity Center (旧AWS SSO)
   - SAML 2.0対応IdP

3. **データ収集方法**
   - Remote Write (Prometheus標準)
   - ADOT Collector (OpenTelemetry)

4. **統合パターン**
   - AMP -> AMG (メトリクス収集から可視化)
   - CloudWatch -> AMG (既存CloudWatchメトリクスの可視化)

### よくある問題パターン

| シナリオ | 解答 |
|---------|------|
| 既存Prometheusをマネージドに移行 | AMP |
| Grafanaダッシュボードを維持したい | AMG |
| EKSのコンテナメトリクス収集 | AMP + ADOT/Prometheus |
| 複数データソースを1画面で可視化 | AMG |
| PromQLクエリを使いたい | AMP |
| SSOでGrafanaにログイン | AMG + IAM Identity Center |
