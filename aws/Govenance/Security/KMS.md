# AWS KMS (Key Management Service)

## Associate Level
- 暗号化キーのライフサイクル管理: フルマネージド / ==Region service== / ==CloudTrail== と統合 (キー使用の監査ログ) / ==FIPS 140-2 Level 2==
  - キーの種類:                   ローテーション後も==古いキーでの復号は可能== (バッキングキー保持)
    | 種類 | 管理者 | ローテーション | ユースケース | 料金 |
    |------|--------|---------------|-------------|----|
    | ==AWS 管理キー== | AWS | 自動 (1年) | シンプル | 無料 |
    | ==カスタマー管理キー (CMK)== | 顧客 | 設定可能 (1年) | 監査、アクセス制御、==クロスアカウント== | ==!$1/月 + API コール== |
    | ==AWS 所有キー== | AWS | AWS が管理 | 一部サービスの内部暗号化 | 無料 |
  - `Key Policy`:                   KMS キーへのアクセスの==Resource Base Policy== / IAM ポリシーと組合せて使用 / def: RootUser FullAccess
  - `エンベロープ暗号化`:           KMS API で直接暗号化できるのは ==4KB まで== なので、この仕組みが必要
    ```
    ┌──────────────────────────────────────────────────────────────────┐
    │                        暗号化の流れ                              │
    ├──────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │   1. GenerateDataKey API                                         │
    │      ┌─────────┐                                                 │
    │      │   KMS   │ ─────> Data Key (平文)      ← データ暗号化に使用│
    │      │  (CMK)  │ ─────> Data Key (暗号化済み) ← 保存用           │
    │      └─────────┘                                                 │
    │                                                                  │
    │   2. データ暗号化                                                │
    │      Data Key (平文) ──暗号化──> 大容量データ                    │
    │                                                                  │
    │   3. 平文の Data Key を ==即座に破棄== (メモリから削除)          │
    │                                                                  │
    │   4. 保存                                                        │
    │      ┌────────────────────────────────┐                          │
    │      │  暗号化済み Data Key + 暗号化データ │ → S3, EBS 等        │
    │      └────────────────────────────────┘                          │
    │                                                                  │
    └──────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────────────┐
    │                        復号の流れ                                │
    ├──────────────────────────────────────────────────────────────────┤
    │                                                                  │
    │   1. Decrypt API                                                 │
    │      ┌─────────┐                                                 │
    │      │   KMS   │ ←── Data Key (暗号化済み)                       │
    │      │  (CMK)  │ ──> Data Key (平文)                             │
    │      └─────────┘                                                 │
    │                                                                  │
    │   2. データ復号                                                  │
    │      Data Key (平文) ──復号──> 元のデータ                        │
    │                                                                  │
    └──────────────────────────────────────────────────────────────────┘
    ```
  - `連携サービス`:
    | サービス | 暗号化対象 |
    |---------|-----------|
    | S3 | オブジェクト (==SSE-KMS==) |
    | EBS | ボリューム |
    | RDS | データベース |
    | EFS | ファイルシステム |
    | Lambda | 環境変数 |
    | Secrets Manager | シークレット |
    | Parameter Store | SecureString |
